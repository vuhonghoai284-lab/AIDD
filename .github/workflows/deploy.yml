name: Deploy Application

on:
  workflow_run:
    workflows: ["Continuous Integration", "Docker Build & Push"]
    branches: [main]
    types: [completed]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      skip_tests:
        description: 'Skip health checks'
        required: false
        default: false
        type: boolean

env:
  DEPLOY_TIMEOUT: 300

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    environment: staging
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging') ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup deployment environment
        run: |
          echo "DEPLOYMENT_ENV=staging" >> $GITHUB_ENV
          echo "APP_URL=https://staging.aidd.example.com" >> $GITHUB_ENV
      
      - name: Deploy notification start
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ° Staging ç¯å¢ƒ..."
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
      
      # è¿™é‡Œåº”è¯¥æ”¾ç½®å®é™…çš„éƒ¨ç½²é€»è¾‘
      # ä¾‹å¦‚ï¼šè°ƒç”¨éƒ¨ç½²è„šæœ¬ã€æ›´æ–°Kubernetesé…ç½®ç­‰
      - name: Deploy application
        run: |
          echo "æ¨¡æ‹Ÿéƒ¨ç½²è¿‡ç¨‹..."
          echo "1. ä¸‹è½½æœ€æ–°é•œåƒ"
          echo "2. æ›´æ–°é…ç½®æ–‡ä»¶"
          echo "3. é‡å¯æœåŠ¡"
          echo "4. è¿è¡Œå¥åº·æ£€æŸ¥"
          sleep 10
      
      - name: Health check
        if: github.event.inputs.skip_tests != 'true'
        run: |
          echo "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
          timeout ${{ env.DEPLOY_TIMEOUT }}s bash -c '
            for i in {1..30}; do
              echo "Health check attempt $i/30"
              # curl -f ${{ env.APP_URL }}/api/system/health && break || sleep 10
              # æ¨¡æ‹Ÿå¥åº·æ£€æŸ¥
              if [ $i -eq 3 ]; then break; fi
              sleep 5
            done
          '
          echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
      
      - name: Deploy notification success
        if: success()
        run: |
          echo "ğŸ‰ Staging éƒ¨ç½²æˆåŠŸ!"
          echo "åº”ç”¨åœ°å€: ${{ env.APP_URL }}"
      
      - name: Deploy notification failure
        if: failure()
        run: |
          echo "âŒ Staging éƒ¨ç½²å¤±è´¥!"
          exit 1

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: production
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Production deployment confirmation
        run: |
          echo "âš ï¸  ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²éœ€è¦é¢å¤–ç¡®è®¤"
          echo "è¯·ç¡®ä¿å·²ç»åœ¨stagingç¯å¢ƒä¸­æµ‹è¯•é€šè¿‡"
      
      - name: Setup production environment
        run: |
          echo "DEPLOYMENT_ENV=production" >> $GITHUB_ENV
          echo "APP_URL=https://aidd.example.com" >> $GITHUB_ENV
      
      - name: Deploy to production
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          
          # ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²é€»è¾‘
          echo "æ¨¡æ‹Ÿç”Ÿäº§éƒ¨ç½²è¿‡ç¨‹..."
          sleep 15
      
      - name: Production health check
        run: |
          echo "ğŸ” æ‰§è¡Œç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥..."
          timeout ${{ env.DEPLOY_TIMEOUT }}s bash -c '
            for i in {1..60}; do
              echo "Production health check $i/60"
              # curl -f ${{ env.APP_URL }}/api/system/health && break || sleep 10
              if [ $i -eq 5 ]; then break; fi
              sleep 5
            done
          '
          echo "âœ… ç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥é€šè¿‡"
      
      - name: Production deploy success
        if: success()
        run: |
          echo "ğŸ‰ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸ!"
          echo "åº”ç”¨åœ°å€: ${{ env.APP_URL }}"
      
      - name: Rollback on failure
        if: failure()
        run: |
          echo "âŒ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å¤±è´¥ï¼Œæ‰§è¡Œå›æ»š..."
          # å›æ»šé€»è¾‘
          echo "å›æ»šå®Œæˆ"
          exit 1

  notify-status:
    name: Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()
    
    steps:
      - name: Deployment summary
        run: |
          echo "## ğŸ“‹ éƒ¨ç½²çŠ¶æ€æ€»ç»“"
          echo "Staging: ${{ needs.deploy-staging.result }}"
          echo "Production: ${{ needs.deploy-production.result }}"
          
          if [[ "${{ needs.deploy-staging.result }}" == "failure" || "${{ needs.deploy-production.result }}" == "failure" ]]; then
            echo "âŒ éƒ¨ç½²è¿‡ç¨‹ä¸­å‡ºç°å¤±è´¥"
          else
            echo "âœ… éƒ¨ç½²å®Œæˆ"
          fi